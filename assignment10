<?php
$output = "";
$acknowledgement = "";

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    require __DIR__ . '/php/rest_client.php';
    $result = get_weather();
    $acknowledgement = $result[0];
    $output = $result[1];
}
?>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <title>Weather API</title>
  </head>

  <body class="container">
  <h1>Enter Zip Code to Get City Weather</h1>
    <form method="post" action="/~sshaper/assignments/assignment10_rest/solution/index.php" class="form-inline">
            <div class="form-group mb-2">
                <label for="zip_code" class="sr-only">Zip Code:</label>
                <input style="width: 25%;" type="text" class="form-control" id="zip_code" name="zip_code">
            </div>
            <button type="submit" class="btn btn-primary mb-2 ml-2">Submit</button>
        </form>

    </body>
</html>

<?php

function get_weather() {
    $out = '';
    $ack = '';

    $zip = isset($_POST['zip_code']) ? trim($_POST['zip_code']) : '';

    if ($zip === '') {
        $ack = '<div class="error">No zip code provided. Please enter a zip code.</div>';
        return [$ack, $out];
    }

    if (!preg_match('/^\d{5}$/', $zip)) {
        $ack = '<div class="error">Invalid zip code format. Use 5 digits.</div>';
        return [$ack, $out];
    }

    $ack = "Requested data for zip code: " . htmlspecialchars($zip);

    $endpoint = 'https://russet-v8.wccnet.edu/~sshaaper/assignments/assignment10_rest/get_weather_json.php';
    $url = $endpoint . '?zip_code=' . urlencode($zip);

    $ch = curl_init();
    curl_setopt_array($ch, [
        CURLOPT_URL => $url,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_FAILONERROR => false,
        CURLOPT_TIMEOUT => 10,
    ]);
    $raw = curl_exec($ch);
    $err = curl_error($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($raw === false || $raw === null || $err) {
        $out .= '<div class="error">There was an error retrieving the records. ' . htmlspecialchars($err) . '</div>';
        return [$ack, $out];
    }

    $json = json_decode($raw, true);
    if ($json === null) {
        $decoded = json_decode(trim($raw), true);
        if ($decoded === null) {
            $out .= '<div class="error">Invalid response from server.</div>';
            return [$ack, $out];
        }
        $json = $decoded;
    }

    if (isset($json['error'])) {
        $out .= '<div class="error">' . htmlspecialchars($json['error']) . '</div>';
        return [$ack, $out];
    }

    if (!isset($json['searched_city'])) {
        $out .= '<div class="error">Unexpected JSON structure returned by server.</div>';
        return [$ack, $out];
    }

    $sc = $json['searched_city'];

    $out .= '<h2>Searched city</h2>';
    $out .= '<table>';
    $out .= '<tr><th>City</th><th>Temperature</th><th>Humidity</th><th>3-day forecast</th></tr>';

    $cityName = isset($sc['name']) ? $sc['name'] : '(unknown)';
    $temp = isset($sc['temperature']) ? $sc['temperature'] : '(n/a)';
    $humidity = isset($sc['humidity']) ? $sc['humidity'] : '(n/a)';

    $forecastText = '';
    if (isset($sc['forecast']) && is_array($sc['forecast'])) {
        $parts = [];
        foreach ($sc['forecast'] as $day) {
            $d = isset($day['day']) ? $day['day'] : '';
            $c = isset($day['condition']) ? $day['condition'] : '';
            if ($d !== '') {
                $parts[] = htmlspecialchars("{$d}: {$c}");
            } else {
                $parts[] = htmlspecialchars($c);
            }
        }
        $forecastText = implode(' | ', $parts);
    }

    $out .= '<tr>';
    $out .= '<td>' . htmlspecialchars($cityName) . '</td>';
    $out .= '<td>' . htmlspecialchars((string)$temp) . '</td>';
    $out .= '<td>' . htmlspecialchars((string)$humidity) . '</td>';
    $out .= '<td>' . ($forecastText ?: 'N/A') . '</td>';
    $out .= '</tr>';
    $out .= '</table>';

    $out .= '<h3>Cities with higher temperatures (up to 3)</h3>';
    if (isset($json['higher_temperatures']) && is_array($json['higher_temperatures']) && count($json['higher_temperatures'])>0) {
        $higher = array_slice($json['higher_temperatures'], 0, 3);
        $out .= '<table>';
        $out .= '<tr><th>City</th><th>Temperature</th></tr>';
        foreach ($higher as $c) {
            $n = isset($c['name']) ? $c['name'] : '(unknown)';
            $t = isset($c['temperature']) ? $c['temperature'] : '(n/a)';
            $out .= '<tr><td>' . htmlspecialchars($n) . '</td><td>' . htmlspecialchars((string)$t) . '</td></tr>';
        }
        $out .= '</table>';
    } else {
        $out .= '<div>No cities with higher temperatures than ' . htmlspecialchars($cityName) . ' were found.</div>';
    }

    $out .= '<h3>Cities with lower temperatures (up to 5)</h3>';
    if (isset($json['lower_temperatures']) && is_array($json['lower_temperatures']) && count($json['lower_temperatures'])>0) {
        $lower = array_slice($json['lower_temperatures'], 0, 5);
        $out .= '<table>';
        $out .= '<tr><th>City</th><th>Temperature</th></tr>';
        foreach ($lower as $c) {
            $n = isset($c['name']) ? $c['name'] : '(unknown)';
            $t = isset($c['temperature']) ? $c['temperature'] : '(n/a)';
            $out .= '<tr><td>' . htmlspecialchars($n) . '</td><td>' . htmlspecialchars((string)$t) . '</td></tr>';
        }
        $out .= '</table>';
    } else {
        $out .= '<div>No cities with lower temperatures than ' . htmlspecialchars($cityName) . ' were found.</div>';
    }

    return [$ack, $out];
}
