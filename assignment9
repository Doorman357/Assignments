<?php
class Db_conn {
    protected $db;

    public function __construct()
    {
        $host   = 'localhost';
        $dbname = 'chaumiller';
        $user   = 'chaumiller';
        $pass   = 'password';

        $dsn = "mysql:host={$host};dbname={$dbname}";

        try {
            $this->db = new PDO($dsn, $user, $pass);
            $this->db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            $this->db->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
            $this->db->setAttribute(PDO::ATTR_EMULATE_PREPARES, false);
        } catch (PDOException $e) {
            exit('Database connection failed: ' . $e->getMessage());
        }
    }

    public function getDb()
    {
        return $this->db;
    }
}

<?php
class Pdo_methods {
    protected $db;

    public function __construct(PDO $db)
    {
        $this->db = $db;
    }

    public function select($sql, $params = [])
    {
        $stmt = $this->db->prepare($sql);
        $stmt->execute($params);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    public function insert($sql, $params = [])
    {
        $stmt = $this->db->prepare($sql);
        $ok = $stmt->execute($params);
        if ($ok) {
            return $this->db->lastInsertId();
        }
        return false;
    }

    public function exists($sql, $params = [])
    {
        $stmt = $this->db->prepare($sql);
        $stmt->execute($params);
        $count = $stmt->fetchColumn();
        return intval($count) > 0;
    }
}

<?php
class StickyForm {
    public static function value($name, $default = '')
    {
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            return htmlspecialchars($_POST[$name] ?? '', ENT_QUOTES);
        }
        return htmlspecialchars($default, ENT_QUOTES);
    }

    public static function isChecked($name, $value)
    {
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            return (isset($_POST[$name]) && $_POST[$name] == $value) ? 'checked' : '';
        }
        return '';
    }
}

<?php
class Validation {
    public static function validateName($name)
    {
        $val = trim($name);
        if ($val === '') {
            return 'Name is required.';
        }
        if (!preg_match("/^[A-Za-z' ]+$/u", $val)) {
            return "Only letters, spaces, and apostrophes are allowed.";
        }
        return '';
    }

    public static function validateEmail($email)
    {
        $val = trim($email);
        if ($val === '') {
            return 'Email is required.';
        }
        if (!filter_var($val, FILTER_VALIDATE_EMAIL)) {
            return 'Invalid email address.';
        }
        return '';
    }

    public static function validatePassword($pwd)
    {
        if ($pwd === '') {
            return 'Password is required.';
        }
        if (strlen($pwd) < 8) {
            return 'Password must be at least 8 characters long.';
        }
        if (!preg_match('/[A-Z]/', $pwd)) {
            return 'Password must include at least 1 uppercase letter.';
        }
        if (!preg_match('/\d/', $pwd)) {
            return 'Password must include at least 1 number.';
        }
        if (!preg_match('/[\W_]/', $pwd)) {
            return 'Password must include at least 1 symbol.';
        }
        return '';
    }
}

<?php
require_once 'classes/Db_conn.php';

$db_conn = new Db_conn();
$conn = $db_conn->getDb();

$formConfig = [
    'masterStatus' => [
        'error' => false,
        'message' => ''

    ],
    'fields' => [
        'firstName' => ['value' => '', 'error' => ''],
        'lastName' => ['value' => '', 'error' => ''],
        'email' => ['value' => '', 'error' => ''],
        'password1' => ['value' => '', 'error' => ''],
        'password2' => ['value' => '', 'error' => '']
    ]
];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    foreach ($formConfig['fields'] as $key => &$f) {
        $f['value'] = trim($_POST[$key] ?? '');
        $f['error'] = '';
    }
    unset($f);

    $pw = $formConfig['fields']['password1']['value'];
    $pw2 = $formConfig['fields']['password2']['value'];
    $email = $formConfig['fields']['email']['value'];

    if (!preg_match('/^(?=.*[A-Z])(?=.*\d)(?=.*\W).{8,}$/', $pw)) {
        $formConfig['fields']['password1']['error'] = 'Must have at least (8 characters, 1 uppercase, 1 symbol, 1 number)';
        $formConfig['masterStatus']['error'] = true;
    }

    if ($pw !== $pw2) {
        $formConfig['fields']['password2']['error'] = 'Your passwords do not match';
        $formConfig['masterStatus']['error'] = true;
    }

    if (!$formConfig['masterStatus']['error']) {
        $stmt = $conn->prepare("SELECT COUNT(*) FROM users WHERE email = ?");
        $stmt->execute([$email]);
        if ($stmt->fetchColumn() > 0) {
            $formConfig['masterStatus']['message'] = 'There is already a record of that email';
            $formConfig['masterStatus']['error'] = true;
        }
    }

    if (!$formConfig['masterStatus']['error']) {
        $hashed = password_hash($pw, PASSWORD_BCRYPT);
        $stmt = $conn->prepare("INSERT INTO users (first_name, last_name, email, password) VALUES (?, ?, ?, ?)");
        $stmt->execute([
            $formConfig['fields']['firstName']['value'],
            $formConfig['fields']['lastName']['value'],
            $email,
            $hashed
        ]);

        $formConfig['masterStatus']['message'] = 'You have been added to the database';
        foreach ($formConfig['fields'] as &$f) {
            $f['value'] = '';
        }
        unset($f);
    }
}

$stmt = $conn->query("SELECT first_name, last_name, email, password FROM users ORDER BY id DESC");
$users = $stmt->fetchAll();
?>

<!DOCTYPE html>
<html>
<head>
    <title>Sticky Form Example</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
</head>
<body>

<div class="container mt-5">
<p>&nbsp;</p>

<?php if ($formConfig['masterStatus']['message']): ?>
    <p><?= htmlspecialchars($formConfig['masterStatus']['message']) ?></p>
<?php endif; ?>

<form method="post" action="">
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="first_name">First Name</label>
                <input type="text" class="form-control" id="first_name" name="firstName" 
                       value="<?= htmlspecialchars($formConfig['fields']['firstName']['value']) ?>">
            </div>
        </div>

        <div class="col-md-6">
            <div class="mb-3">
                <label for="last_name">Last Name</label>
                <input type="text" class="form-control" id="last_name" name="lastName" 
                       value="<?= htmlspecialchars($formConfig['fields']['lastName']['value']) ?>">
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="mb-3">
                <label for="email">Email</label>
                <input type="text" class="form-control" id="email" name="email"
                       value="<?= htmlspecialchars($formConfig['fields']['email']['value']) ?>">
            </div>
        </div>

        <div class="col-md-4">
            <div class="mb-3">
                <label for="password1">Password</label>
                <input type="text" class="form-control" id="password1" name="password1" value="">
                <?php if ($formConfig['fields']['password1']['error']): ?>
                    <small class="text-danger"><?= htmlspecialchars($formConfig['fields']['password1']['error']) ?></small>
                <?php endif; ?>
            </div>
        </div>

        <div class="col-md-4">
            <div class="mb-3">
                <label for="password2">Confirm Password</label>
                <input type="text" class="form-control" id="password2" name="password2" value="">
                <?php if ($formConfig['fields']['password2']['error']): ?>
                    <small class="text-danger"><?= htmlspecialchars($formConfig['fields']['password2']['error']) ?></small>
                <?php endif; ?>
            </div>
        </div>
    </div>

    <input type="submit" class="btn btn-primary" value="Register">
</form>

<?php if (count($users) > 0): ?>
<table class="table table-bordered mt-2">
    <tr>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Email</th>
        <th>Password</th>
    </tr>
    <?php foreach ($users as $u): ?>
    <tr>
        <td><?= htmlspecialchars($u['first_name']) ?></td>
        <td><?= htmlspecialchars($u['last_name']) ?></td>
        <td><?= htmlspecialchars($u['email']) ?></td>
        <td><?= htmlspecialchars($u['password']) ?></td>
    </tr>
    <?php endforeach; ?>
</table>
<?php else: ?>
    <p class="mt-3">No records to display</p>
<?php endif; ?>

</div>

</body>
</html>
